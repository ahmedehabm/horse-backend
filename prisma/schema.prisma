// prisma/schema.prisma — Version 2 (Cascade delete horses with user)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ========================================
// ENUMS - System States
// ========================================
enum Role {
  USER
  ADMIN
}

enum DeviceType {
  CAMERA
  FEEDER
}

enum FeederType {
  MANUAL
  SCHEDULED
}

enum FeedingStatus {
  PENDING
  STARTED
  RUNNING
  COMPLETED
  FAILED
}

// ========================================
// USER
// ========================================
model User {
  id                   String    @id @default(uuid())
  name                 String?
  username             String    @unique
  password             String
  passwordChangedAt    DateTime?
  passwordResetToken   String?   @unique
  passwordResetExpires DateTime?
  role                 Role      @default(USER)

  activeStreamHorseId  String?

  horses               Horse[]

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([username])
  @@index([passwordResetToken])
}

// ========================================
// DEVICE (Polymorphic)
// ========================================
model Device {
  id                  String      @id @default(uuid())
  deviceType          DeviceType
  thingLabel          String      @unique
  thingName           String      @unique @default(cuid())
  location            String

  // FEEDER-specific
  feederType          FeederType  @default(MANUAL)
  morningTime         String?
  dayTime             String?
  nightTime           String?
  scheduledAmountKg   Float?

  // CAMERA-specific
  streamToken         String?     @unique
  streamTokenIsValid  Boolean?

  // Relations
  horsesAsFeeder      Horse[]     @relation("HorseFeeder")
  horsesAsCamera      Horse[]     @relation("HorseCamera")
  feedings            Feeding[]
  activeFeedings      ActiveFeeding[]

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@index([thingName])
  @@index([deviceType])
  @@index([streamToken])
}

// ========================================
// HORSE
// ========================================
model Horse {
  id             String        @id @default(uuid())
  name           String
  age            Int
  breed          String
  image          String?
  location       String

  //  Delete user → ALL user's horses get deleted
  owner          User?         @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId        String?

  //  Delete device → horse.feederId becomes null (device freed, horse survives)
  feederId       String?       @unique
  feeder         Device?       @relation("HorseFeeder", fields: [feederId], references: [id], onDelete: SetNull)

  //  Delete device → horse.cameraId becomes null (device freed, horse survives)
  cameraId       String?       @unique
  camera         Device?       @relation("HorseCamera", fields: [cameraId], references: [id], onDelete: SetNull)

  lastFeedAt     DateTime?

  feedings       Feeding[]
  activeFeeding  ActiveFeeding?

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([ownerId])
  @@index([feederId])
  @@index([cameraId])
}

// ========================================
// FEEDING (History / Audit)
// ========================================
model Feeding {
  id            String         @id @default(uuid())

  horse         Horse          @relation(fields: [horseId], references: [id], onDelete: Cascade)
  horseId       String

  device        Device         @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  deviceId      String

  status        FeedingStatus  @default(PENDING)
  requestedKg   Float

  startedAt     DateTime?
  completedAt   DateTime?

  isScheduled   Boolean        @default(false)
  timeSlot      String?

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([horseId])
  @@index([deviceId])
  @@index([status])
}

// ========================================
// ACTIVE FEEDING (Live Snapshot - FAST READ)
// ========================================
model ActiveFeeding {
  id            String         @id @default(uuid())

  horse         Horse          @relation(fields: [horseId], references: [id], onDelete: Cascade)
  horseId       String         @unique

  device        Device         @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  deviceId      String

  feedingId     String
  status        FeedingStatus

  requestedKg   Float

  startedAt     DateTime?
  updatedAt     DateTime       @updatedAt

  @@index([status])
}